<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gbk" />
<title>sphinx全文索引教程 - 全文检索 - PHPCMS V9 在线帮助文档</title>
<meta name="keywords" content="sphinx全文索引教程,全文索引教程sphinx全文索引">
<meta name="description" content="英文介绍：http://www.sphinxsearch.com/docs/manual-0.9.9.html一、首先需要在服务器上安装sphinx在Windows上安装sphinx&amp;nbsp; &amp;nbsp; 1.下载支持mysql的包&amp;nbsp;&amp;nbsp;http://www.sphinxsearch.com/downloads/sphinx-0.9.9-win32...">
<style type="text/css">
<!--
*{ padding:0; margin:0}
h5 a, a{color:#000}
h5{font-size:14px; font-weigth:normal }
ul,li{ list-style:none}
a{text-decoration:none;}
a:hover{text-decoration:underline;}
body,html{background: url("statics/images/img/left-bg.png"/*tpa=http://v9.help.phpcms.cn/statics/images/img/left-bg.png*/) repeat-y; font:12px/20px "tahoma,verdana,arial,sans-serif"}
h1{font-size:34px;}h2{font-size:26px; padding:8px 0 16px}h3{font-size:18px; }h4{font-size:16px;}h5{font-size:14px;}h6{font-size:12px;}
.f12{font-size: 12px}.f14{font-size: 14px}.f16{font-size: 16px}.f18{font-size:18px}.f20{font-size:20px}
.lh20{line-height: 20px}.lh22{line-height: 22px}.lh24{line-height: 24px}.lh26{line-height: 26px}.lh28{line-height: 28px}
.fb{ font-weight:bold}.fn{ font-weight:normal}
.bk,.bk3,.bk6,.bk8,.bk10,.bk15,.bk20,.bk30{clear: both;font-size: 1px;height: 0;line-height: 1px}
.bk3{height: 3px;}.bk6{height: 6px}.bk8{height: 8px}.bk10{height: 10px}.bk15{height: 15px}.bk20{height: 20px}.bk30{height: 30px}
.row-2 li{ float:left; width:50%}.row-3 li{ float:left; width:33%}.row-4 li{ float:left; width:25%}.row-5 li{ float:left; width:20%}
.cu,.cu-li li,.cu-span span {cursor: hand;!important;cursor: pointer}
.text-c{text-align: center}.text-l{text-align: left}.text-r{text-align: right}
.lf{float: left}.rt{float: right}.pr{ position:relative}.pa{ position:absolute}

.header {background: url("statics/images/img/logo.png"/*tpa=http://v9.help.phpcms.cn/statics/images/img/logo.png*/) no-repeat 15px center #0065b2;border-bottom: 1px solid #00508d; height:34px; line-height:34px}
.nav{ float:right; padding-right:16px;}
.nav a{ color:#e2e9ea}
.maincol{ overflow:hidden}
.col-left{ float:left; width:163px; padding:15px 0 0 15px; margin-right:10px}
.col-auto{ overflow:hidden;_float:left; zoom:1; padding:15px 10px 0 0;font-size:14px; line-height:30px;}
.sidebar{ margin-bottom:8px}
.sidebar li{ line-height:18px;}
.sidebar li a{color:#0066dd; background: url("statics/images/img/o.png"/*tpa=http://v9.help.phpcms.cn/statics/images/img/o.png*/) no-repeat left center; padding-left:8px}
.letter{ padding:10px 0}
.letter a { display:inline-block; width:26px; height:22px; line-height:21px; background:#fff; border:1px solid #e3e3e3; text-align:center; color:#333; margin-right:5px}
.letter a { background:url("statics/images/img/pages.png"/*tpa=http://v9.help.phpcms.cn/statics/images/img/pages.png*/) no-repeat 0 5px; font-family:Arial, Helvetica, sans-serif}
.letter a:hover { background:#f1f1f1; color:#000; text-decoration:none;}
.letter a.cur{background:#5a85b2; border:1px solid #5a85b2; color:#fff;}

.letNum{background-color: #EFEFEF; padding:3px 8px}
.letNum span{ font-size:12px; font-weight:normal}
.letList{ padding:10px}
.letList dd{ border:1px solid #eee; padding:3px 5px; color: #666; margin-bottom:8px}
.src-code {background-color:#f4f9fe;border:1px solid #e8e8e8;	font-family:'Courier New',Courier,monospace;font-weight:normal;margin:0;overflow:auto;padding:1em}
.separator {background-color:#bed0e4;height:1px;}
hr{border-color:#bed0e4;border-style:solid;height:1px;margin-bottom:10px;margin-top:10px}
blockquote{border:dashed 1px; padding:5px; background :#F2F2F2}
blockquote em{font-style:normal;font-size:12px;}

ol{padding-left:40px}
ol li{list-style-type: decimal; text-indent:-8px}
.content_end a{font-weight:bold}
.clear{clear:both}
.footer{text-align:center;margin:auto}
-->
</style>
<link href="statics/css/prettify.css" tppabs="http://v9.help.phpcms.cn/statics/css/prettify.css" type="text/css" rel="stylesheet" /> 
<script type="text/javascript" src="statics/js/prettify/prettify.js" tppabs="http://v9.help.phpcms.cn/statics/js/prettify/prettify.js"></script>
</head>

<body onload="prettyPrint()">
<div class="header">
<span class="nav"></span>
</div><a name="top"></a>
    <div class="col-left">
     <h5><a href="index.htm" tppabs="http://v9.help.phpcms.cn/">PHPCMS V9帮助中心</a></h5>
            <h5><a href="index.php-m=content&c=index&a=lists&catid=145&page=1.htm" tppabs="http://v9.help.phpcms.cn/index.php?m=content&c=index&a=lists&catid=145&page=1">全文检索</a></h5>
                <ul class="sidebar">
                     	<li><a href="index.php-m=content&c=index&a=show&catid=145&id=35.htm" tppabs="http://v9.help.phpcms.cn/index.php?m=content&c=index&a=show&catid=145&id=35" title="sphinx全文索引教程"><b>sphinx全文索引教程</b></a></li>
        	        </ul>
            </div>
    <div class="col-auto">
    <h2>sphinx全文索引教程</h2>
     <p>
	英文介绍：<a href="javascript:if(confirm('http://www.sphinxsearch.com/docs/manual-0.9.9.html  \n\n该文件未被 Teleport Pro 下载，因为 它位于起始地址以设置的边界以外的域或路径中。  \n\n你想要从服务器打开它吗?'))window.location='http://www.sphinxsearch.com/docs/manual-0.9.9.html'" tppabs="http://www.sphinxsearch.com/docs/manual-0.9.9.html" target="_blank">http://www.sphinxsearch.com/docs/manual-0.9.9.html</a><br />
	<br />
	一、首先需要在服务器上安装sphinx<br />
	在Windows上安装sphinx<br />
	&nbsp; &nbsp; 1.下载支持mysql的包&nbsp;&nbsp;<a href="javascript:if(confirm('http://www.sphinxsearch.com/downloads/sphinx-0.9.9-win32.zip  \n\n该文件未被 Teleport Pro 下载，因为 它位于起始地址以设置的边界以外的域或路径中。  \n\n你想要从服务器打开它吗?'))window.location='http://www.sphinxsearch.com/downloads/sphinx-0.9.9-win32.zip'" tppabs="http://www.sphinxsearch.com/downloads/sphinx-0.9.9-win32.zip" target="_blank">http://www.sphinxsearch.com/downloads/sphinx-0.9.9-win32.zip</a><br />
	&nbsp; &nbsp; 2.解压缩 sphinx-0.9.9-win32.zip 到 D:\sphinx<br />
	&nbsp; &nbsp; 3.安装sphinx服务，在命令行执行命令</p>
<blockquote>
	<p>
		D:\sphinx\searchd --install --config d:\sphinx\sphinx.conf --servicename SphinxSearch</p>
</blockquote>
<p>
	<br />
	&nbsp;&nbsp;&nbsp; 英文参照：<a href="javascript:if(confirm('http://www.sphinxsearch.com/docs  \n\n该文件未被 Teleport Pro 下载，因为 它位于起始地址以设置的边界以外的域或路径中。  \n\n你想要从服务器打开它吗?'))window.location='http://www.sphinxsearch.com/docs'" tppabs="http://www.sphinxsearch.com/docs" target="_blank">http://www.sphinxsearch.com/docs</a> ... #installing-windows<br />
	<br />
	在Linux服务器上安装sphinx<br />
	&nbsp; &nbsp;1.下载源码包 <a href="javascript:if(confirm('http://www.sphinxsearch.com/downloads/sphinx-0.9.9.tar.gz  \n\n该文件未被 Teleport Pro 下载，因为 它位于起始地址以设置的边界以外的域或路径中。  \n\n你想要从服务器打开它吗?'))window.location='http://www.sphinxsearch.com/downloads/sphinx-0.9.9.tar.gz'" tppabs="http://www.sphinxsearch.com/downloads/sphinx-0.9.9.tar.gz" target="_blank">http://www.sphinxsearch.com/downloads/sphinx-0.9.9.tar.gz</a></p>
<blockquote>
	<p>
		$ tar xzvf sphinx-0.9.8.tar.gz<br />
		$ cd sphinx<br />
		$ ./configure --prefix=/usr/local/sphinx --with-mysql=/usr/local/mysql<br />
		$ make<br />
		$ make install</p>
</blockquote>
<p>
	&nbsp;</p>
<p>
	sphinx.conf样例 &nbsp;</p>
<blockquote>
	<p>
		source main<br />
		{<br />
		&nbsp;type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= mysql&nbsp;&nbsp;&nbsp;&nbsp;#数据库类型<br />
		&nbsp;sql_host&nbsp;&nbsp;&nbsp;&nbsp;= 10.228.134.211&nbsp;#数据库ip<br />
		&nbsp;sql_user&nbsp;&nbsp;&nbsp;&nbsp;= admin&nbsp;&nbsp;&nbsp;&nbsp;#数据库用户名<br />
		&nbsp;sql_pass&nbsp;&nbsp;&nbsp;&nbsp;= admin&nbsp;&nbsp;&nbsp;&nbsp;#数据库密码<br />
		&nbsp;sql_db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= phpcms_v9&nbsp;&nbsp;&nbsp;#数据库名<br />
		&nbsp;sql_port&nbsp;&nbsp;&nbsp;&nbsp;= 3306&nbsp;&nbsp;&nbsp;&nbsp;# 数据库端口</p>
	<p>
		&nbsp;sql_query_pre = SET NAMES utf8<br />
		&nbsp;sql_query_pre = REPLACE INTO v9_sphinx_counter SELECT 1, MAX(searchid) FROM v9_search<br />
		&nbsp;sql_query = SELECT searchid, adddate, siteid, typeid, id, data FROM v9_search \<br />
		&nbsp;&nbsp;WHERE searchid&lt;=( SELECT max_doc_id FROM v9_sphinx_counter WHERE counter_id=1 )&nbsp;</p>
	<p>
		&nbsp;#字符串属性设置、需要过滤、排序的时候用到<br />
		&nbsp;sql_attr_uint&nbsp;&nbsp;= typeid<br />
		&nbsp;sql_attr_uint&nbsp;&nbsp;= siteid<br />
		&nbsp;sql_attr_uint&nbsp;&nbsp;= id<br />
		&nbsp;sql_attr_timestamp&nbsp; = adddate<br />
		&nbsp;sql_query_info&nbsp;&nbsp;= SELECT * FROM v9_search WHERE searchid=$id<br />
		}</p>
	<p>
		source delta : main<br />
		{<br />
		&nbsp;&nbsp;&nbsp; sql_query_pre = SET NAMES utf8<br />
		&nbsp;&nbsp;&nbsp; sql_query = SELECT searchid, adddate, siteid, typeid, id, data FROM v9_search \<br />
		&nbsp;&nbsp;WHERE searchid &gt;( SELECT max_doc_id FROM v9_sphinx_counter WHERE counter_id=1 )<br />
		}</p>
	<p>
		#主索引<br />
		index main<br />
		{<br />
		&nbsp;source = main<br />
		&nbsp;# 放索引的目录<br />
		&nbsp;path = D:\sphinx\data\main<br />
		&nbsp;# 编码<br />
		&nbsp;charset_type = utf-8<br />
		&nbsp;# 指定utf-8的编码表<br />
		&nbsp;charset_table = 0..9, A..Z-&gt;a..z, _, a..z, U+410..U+42F-&gt;U+430..U+44F, U+430..U+44F<br />
		&nbsp;# 简单分词，只支持0和1，如果要搜索中文，请指定为1<br />
		&nbsp;ngram_len = 1<br />
		&nbsp;# 需要分词的字符，如果要搜索中文，去掉前面的注释<br />
		&nbsp;ngram_chars&nbsp;&nbsp; = U+3000..U+2FA1F<br />
		}</p>
	<p>
		#增量索引<br />
		index delta : main<br />
		{<br />
		&nbsp;&nbsp;&nbsp; source = delta<br />
		&nbsp;&nbsp;&nbsp; path = D:\sphinx\data\delta<br />
		}</p>
	<p>
		indexer<br />
		{<br />
		&nbsp;mem_limit&nbsp;&nbsp;&nbsp;&nbsp;= 128M<br />
		}</p>
	<p>
		searchd<br />
		{<br />
		&nbsp;port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 9312<br />
		&nbsp;log&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= D:\sphinx\data\phpcms\searchd.log<br />
		&nbsp;query_log&nbsp;&nbsp;&nbsp;&nbsp;= D:\sphinx\data\phpcms\query.log<br />
		&nbsp;read_timeout&nbsp;&nbsp;&nbsp;= 5<br />
		&nbsp;max_children&nbsp;&nbsp;&nbsp;= 30<br />
		&nbsp;pid_file&nbsp;&nbsp;&nbsp;&nbsp;= D:\sphinx\data\phpcms\searchd.pid<br />
		&nbsp;max_matches&nbsp;&nbsp;&nbsp;&nbsp;= 2000<br />
		&nbsp;seamless_rotate&nbsp;&nbsp;&nbsp;= 0<br />
		&nbsp;preopen_indexes&nbsp;&nbsp;&nbsp;= 0<br />
		&nbsp;unlink_old&nbsp;&nbsp;&nbsp;&nbsp;= 1<br />
		}</p>
</blockquote>
<p>
	&nbsp;</p>
<p>
	附件：设置计划任务更新索引<br />
	1.windows下<br />
	需要设置计划任务<br />
	#凌晨4点合并索引，执行merge.bat<br />
	#其余时间每分钟更新索引，执行delta.bat<br />
	&nbsp;<br />
	merge.bat &nbsp;</p>
<blockquote>
	<p>
		@ECHO off<br />
		D:\sphinx\bin\indexer.exe --config D:\sphinx\sphinx.conf --merge main delta --rotate<br />
		echo indexing, window will close when complete<br />
		&nbsp;</p>
</blockquote>
<p>
	&nbsp;</p>
<p>
	delta.bat</p>
<blockquote>
	<p>
		<br />
		@ECHO off<br />
		D:\sphinx\bin\indexer.exe --config D:\sphinx\sphinx.conf delta --rotate<br />
		echo indexing, window will close when complete</p>
</blockquote>
<p>
	<br />
	2.linux下编辑定时任务 crontab -e</p>
<blockquote>
	<p>
		<br />
		#凌晨4点合并索引，其余时间每分钟更新索引<br />
		* 0-3 * * * /usr/local/sphinx/bin/indexer --config /usr/local/sphinx/etc/sphinx.conf delta --rotate<br />
		* 6-23 * * * /usr/local/sphinx/bin/indexer --config /usr/local/sphinx/etc/sphinx.conf delta --rotate<br />
		0 4 * * * /usr/local/sphinx/bin/indexer --config /usr/local/sphinx/etc/sphinx.conf --merge main delta --rotate</p>
</blockquote>
<p>
	<br />
	<font color="#ff0000">各种路径、权限需要应用所在服务器一致，</font><font color="#ff0000">如：</font><br />
	sphinx.conf 中需要配置<br />
	sql_host 数据库主机地址<br />
	sql_user 数据库用户名<br />
	sql_pass 数据库密码<br />
	sql_db 数据库名<br />
	sql_port 数据库端口<br />
	phpcms表前缀样例中为phpcms_<br />
	索引路径 D:\sphinx\data\delta</p>
<p>
	<a href="javascript:if(confirm('http://v9.help.phpcms.cn/phpcmsv9_withsphinx.zip  \n\n该文件未被 Teleport Pro 下载，因为 它是一个位于已被站点的漫游器排除标准参数所忽略的路径地址。(Teleport Pro 可以对该选项进行设置，请查阅“工程属性”-“网络规范”)  \n\n你想要从服务器打开它吗?'))window.location='http://v9.help.phpcms.cn/phpcmsv9_withsphinx.zip'" tppabs="http://v9.help.phpcms.cn/phpcmsv9_withsphinx.zip">phpcmsv9_withsphinx.zip</a><br />
	&nbsp;</p>     <div class="content_end"><a href="#top">回到顶部↑</a> </div>
    </div>
</div>
<div class="clear"></div>
<div class="footer">PHPCMS 帮助文档 &copy; 2010 盛大网络发展有限公司</div>
</body>
</html>